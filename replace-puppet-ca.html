<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Replacing a Puppet CA Cert</title>
        <link rel="stylesheet" href="http://blkperl.github.com/theme/css/main.css" />
        <link href="http://blkperl.github.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="puppet resource blog author=blkperl Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://blkperl.github.com/">puppet resource blog author=blkperl </a></h1>
                <nav><ul>
                    <li><a href="http://blkperl.github.com/category/centos.html">centos</a></li>
                    <li><a href="http://blkperl.github.com/category/ganeti.html">ganeti</a></li>
                    <li><a href="http://blkperl.github.com/category/graphite.html">graphite</a></li>
                    <li><a href="http://blkperl.github.com/category/lxc.html">lxc</a></li>
                    <li class="active"><a href="http://blkperl.github.com/category/puppet.html">puppet</a></li>
                    <li><a href="http://blkperl.github.com/category/solaris.html">solaris</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://blkperl.github.com/replace-puppet-ca.html" rel="bookmark"
           title="Permalink to Replacing a Puppet CA Cert">Replacing a Puppet CA Cert</a></h1>
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="pdx_blkperl">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-03-26T22:50:00">
                Tue 26 March 2013
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://blkperl.github.com/author/william-van-hevelingen.html">William Van Hevelingen</a>
        </address>
<p>In <a href="http://blkperl.github.com/category/puppet.html">puppet</a>. </p>
<p>tags: <a href="http://blkperl.github.com/tag/puppet.html">puppet</a><a href="http://blkperl.github.com/tag/openssl.html">openssl</a></p>
</footer><!-- /.post-info -->      <p>This is more of a story than a tutorial and I make no claims that this is the "correct" way to replace a Puppet CA cert but this is how we did it.</p>
<p>Our puppet ca cert was going to expire in about 18 hours so we set aside some time when no one else was working on other systems and madly searched the internet for tidbits of information to replace the cert.</p>
<p>In our environment we have a Puppet CA Server, a puppetmaster, and puppetdb/dashboard server and about 200 nix clients.</p>
<h2>Prep Work</h2>
<ul>
<li>Stop all puppet agents.</li>
</ul>
<p>If running the daemon, run <code>service puppet stop</code> on all the clients</p>
<p>If running by cron then disable all the puppet crons.</p>
<p>This is not necessary but it will prevent the clients from spamming logs while you replace the certs. It may also prevent some clients from getting into a weird limbo state.</p>
<ul>
<li>Verify time is correct on all the puppetmasters.</li>
</ul>
<p>If the servers are not in sync then the certs generated will not work. I would recommend using NTP if you're not already running it.</p>
<h2>Generate a new CA Cert</h2>
<p>On the puppet ca remove the expired cert.</p>
<div class="highlight"><pre>rm -rf /var/lib/puppet/ssl
</pre></div>


<p>Add any alternate dns names to /etc/puppet/puppet.conf</p>
<div class="highlight"><pre><span class="n">dns_alt_names</span><span class="o">=</span><span class="n">puppetca</span><span class="p">,</span><span class="n">puppetca</span><span class="p">.</span><span class="n">cat</span><span class="p">.</span><span class="n">pdx</span><span class="p">.</span><span class="n">edu</span><span class="p">,</span><span class="n">zeratul</span><span class="p">.</span><span class="n">cat</span><span class="p">.</span><span class="n">pdx</span><span class="p">.</span><span class="n">edu</span><span class="p">,</span><span class="n">zeratul</span>
</pre></div>


<p>Review the puppet.conf docs for other CA settings you may want to set before moving on.</p>
<h2>Generate a new cert for the CA</h2>
<div class="highlight"><pre>puppet cert --generate zeratul.cat.pdx.edu
</pre></div>


<p>Verify the new ca.pem and ca cert look correct.</p>
<div class="highlight"><pre>openssl x509 -text -noout -in /var/lib/puppet/ssl/certs/ca.pem
openssl x509 -text -noout -in /var/lib/puppet/ssl/certs/zeratul.cat.pdx.edu.pem
</pre></div>


<p>Specifically, the validity field should now be 5 years in the future. You can set the expiration date in puppet.conf before you generate the cert if you want a longer or shorter period.</p>
<div class="highlight"><pre>openssl x509 -text -noout -in /var/lib/puppet/ssl/certs/ca.pem | grep -i validity -A 2
        Validity
            Not Before: Mar 25 03:20:40 2013 GMT
            Not After : Mar 25 03:20:40 2018 GMT
</pre></div>


<p>Restart apache.</p>
<div class="highlight"><pre>service apache2 restart
</pre></div>


<h2>Generate a new cert for each puppet master</h2>
<div class="highlight"><pre><span class="c"># request a new cert on the puppetmaster</span>
puppet agent --test --dns_alt_names<span class="o">=</span>tassadar,tassadar.cat.pdx.edu,puppet,puppet.cat.pdx.edu

<span class="c"># on the ca server sign the cert</span>
puppet cert --allow-dns-alt-names sign tassadar.cat.pdx.edu

<span class="c"># restart apache on the puppet master</span>
service apache2 restart
</pre></div>


<p>At this point your puppet master if configured to be an agent of itself, should be able to run <code>puppet agent --test</code> with no errors unless you are running puppetdb.</p>
<h2>Generate a new cert for puppetdb</h2>
<p>The <a href="http://docs.puppetlabs.com/puppetdb/1.1/maintain_and_tune.html#redo-ssl-setup-after-changing-certificates">official docs</a> did not work for us. We had to add some additional steps documented below and we filed a <a href="https://projects.puppetlabs.com/issues/19904">bug</a> to update the docs or fix the <code>puppetdb-ssl-setup</code> command.</p>
<div class="highlight"><pre><span class="c"># Remove the old puppetdb certs on the puppetdb server</span>
rm -rf /etc/puppetdb/ssl

<span class="c"># Generate new puppetdb certs</span>
puppetdb-ssl-setup

<span class="c"># restart the service</span>
service puppetdb restart

<span class="c"># verify it restarts by watching the log (it may take a few minutes)</span>
tail -f /var/log/puppetdb/puppetdb.log
</pre></div>


<p>At this point if you did everything correct, the puppetmaster should be able to checkin to itself as a client with no errors and be able to download a catalog.</p>
<h2>Request a cert for dashboard</h2>
<p>Excerpt from the <a href="http://docs.puppetlabs.com/dashboard/manual/1.2/configuring.html">official docs</a> for the 1.2 stable release of dashboard.</p>
<div class="highlight"><pre><span class="c"># on the dashboard server</span>
<span class="nb">cd</span> /usr/share/puppet-dashboard
rake cert:request

<span class="c"># on the ca server</span>
puppet cert sign dashboard

<span class="c"># restart apache on the dashboard server</span>
service apache2 restart
</pre></div>


<h2>Generate new certs for all your clients</h2>
<p>Note if any clients are offline during the process they will need a new cert generated and signed when they come back online.</p>
<p>We used a bash for loop that looked something like this.</p>
<div class="highlight"><pre>cat alltheclients.txt | xargs -P 10 -n 1 -I box ssh -4 box <span class="s1">&#39;rm -fr /var/lib/puppet/ssl &amp;&amp; puppet agent -t&#39;</span>
</pre></div>


<p>The key part in this bash one liner is removing <code>/var/lib/puppet/ssl</code> and requesting a new cert.</p>
<p>Then on the puppet ca server we signed the new certs</p>
<div class="highlight"><pre><span class="c"># For each client sign the new cert</span>
puppet cert sign client2.cat.pdx.edu
</pre></div>


<p>Or you can use the <code>--all</code> flag</p>
<p>There are some security risks with doing this. Basically for the same reasons on why not to use autosign. Read Brice's <a href="http://www.masterzen.fr/2010/11/14/puppet-ssl-explained/">blog</a> for more information about Puppet and SSl.</p>
<div class="highlight"><pre>puppet cert sign --all
</pre></div>


<h2>Summary</h2>
<p>This was a really painful process and is poorly documented. A lot of the clients were left in a broken state and needed to be kicked because the original for loop failed (probably because we didn't turn off the agents first). About 3 hours after we begun we had most of the clients working again and we fixed some stragglers the next day.</p>
<p>If someone has a better/easier process for doing this, please blog about it or submit a pull request to the <a href="http://docs.puppetlabs.com/contribute.html#editing-the-documentation">official docs</a>.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://blkperl.github.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="http://twitter.com/pdx_blkperl">twitter</a></li>
                            <li><a href="http://github.com/blkperl">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>