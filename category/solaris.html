<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>puppet resource blog author=blkperl - solaris</title>
        <link rel="stylesheet" href="http://blkperl.github.com/theme/css/main.css" />
        <link href="http://blkperl.github.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="puppet resource blog author=blkperl Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://blkperl.github.com/">puppet resource blog author=blkperl </a></h1>
                <nav><ul>
                    <li><a href="http://blkperl.github.com/category/centos.html">centos</a></li>
                    <li><a href="http://blkperl.github.com/category/ganeti.html">ganeti</a></li>
                    <li><a href="http://blkperl.github.com/category/lxc.html">lxc</a></li>
                    <li><a href="http://blkperl.github.com/category/puppet.html">puppet</a></li>
                    <li class="active"><a href="http://blkperl.github.com/category/solaris.html">solaris</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://blkperl.github.com/vagrant_solaris11.html">Using Vagrant with Solaris 11</a></h1>
<footer class="post-info">
        <abbr class="published" title="2014-02-19T23:23:00-08:00">
                Published: Wed 19 February 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://blkperl.github.com/author/william-van-hevelingen.html">William Van Hevelingen</a>
        </address>
<p>In <a href="http://blkperl.github.com/category/solaris.html">solaris</a>. </p>
<p>tags: <a href="http://blkperl.github.com/tag/solaris.html">solaris</a> <a href="http://blkperl.github.com/tag/vagrant.html">vagrant</a> </p>
</footer><!-- /.post-info --><p>I finally got Solaris 11 vagrant boxes working! </p>
<p>First you need to download a Solaris 11 iso from Oracle's website. Then use packer to build a solaris11 box file which is explained in Alan Chalmer's <a href="http://resilvered.blogspot.com/2014/02/solaris-vagrant-packer-and-base-box.html">blog</a>.</p>
<p>Next we need a Vagrantfile, you can pull down mine and modify it for your needs. Then create an iso directory and place your solaris box image in it.</p>
<div class="highlight"><pre>git clone https://gist.github.com/9108604.git
mkdir iso
cp /packer/build/directory/packer_solaris-11.1-amd64_virtualbox.box iso/
</pre></div>


<p>Our Vagrantfile looks like this. To mirror a production setup we are creating a secondary disk on the IDE controller to mirror rpool. Then we create a SATA controller and attach six 1G disks.</p>
<div class="gist">
    <script src='https://gist.github.com/9108604.js'></script>
    <noscript>
        <pre><code># -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrantfile API/syntax version. Don't touch unless you know what you're doing!
VAGRANTFILE_API_VERSION = "2"

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

  diskroot = "/home/#{ENV['USER']}/VirtualBox\ VMs/"

  config.vm.define "sunosfiler" do |v|
    v.vm.box = "solaris-11.1"
    v.vm.hostname = "sunosfiler"
    v.vm.network :private_network, ip: "192.168.2.13"
    v.vm.box_url = "iso/packer_solaris-11.1-amd64_virtualbox.box"
    v.vm.provider :virtualbox do |vb|
      # Create a sata controller for our disks
      vb.customize ["storagectl", :id, "--name", "SATA Controller", "--add", 'sata']
      # Create a second disk for the rpool mirror
      diskname = "#{diskroot}/sunosfiler-ide1.vdi"
      vb.customize ['createhd', '--filename', diskname, '--size', 8 * 1024]
      vb.customize ['storageattach', :id, '--storagectl', 'IDE Controller', '--port', 1, '--device', 0, '--type', 'hdd', '--medium', diskname]
    end
    # Create six disks for a zpool
    v.vm.provider :virtualbox do |vb|
      ["1","2","3","4","5","6"].each do |disk|
       diskname = "#{diskroot}/sunosfiler-sata#{disk}.vdi"
       vb.customize ['createhd', '--filename', diskname, '--size', 1024]
       vb.customize ['storageattach', :id, '--storagectl', 'SATA Controller', '--port', disk, '--device', 0, '--type', 'hdd', '--medium', diskname]
      end
    end
  end
end</code></pre>
    </noscript>
</div>
<p>Now that we have everything we need we can start the vm with vagrant up.</p>
<div class="highlight"><pre>vagrant up
Bringing machine <span class="s1">&#39;sunosfiler&#39;</span> up with <span class="s1">&#39;virtualbox&#39;</span> provider...
<span class="o">[</span>sunosfiler<span class="o">]</span> Box <span class="s1">&#39;solaris-11.1&#39;</span> was not found. Fetching box from specified URL <span class="k">for</span>
the provider <span class="s1">&#39;virtualbox&#39;</span>. Note that <span class="k">if</span> the URL does not have
a box <span class="k">for</span> this provider, you should interrupt Vagrant now and add
the box yourself. Otherwise Vagrant will attempt to download the
full box prior to discovering this error.
Downloading or copying the box...
Extracting box...te: 25.0M/s, Estimated <span class="nb">time </span>remaining: 0:00:01<span class="o">)</span>
Successfully added box <span class="s1">&#39;solaris-11.1&#39;</span> with provider <span class="s1">&#39;virtualbox&#39;</span>!
<span class="o">[</span>sunosfiler<span class="o">]</span> Importing base box <span class="s1">&#39;solaris-11.1&#39;</span>...
<span class="o">[</span>sunosfiler<span class="o">]</span> Matching MAC address <span class="k">for</span> NAT networking...
<span class="o">[</span>sunosfiler<span class="o">]</span> Setting the name of the VM...
<span class="o">[</span>sunosfiler<span class="o">]</span> Setting the name of the VM...
<span class="o">[</span>sunosfiler<span class="o">]</span> Clearing any previously <span class="nb">set </span>forwarded ports...
<span class="o">[</span>sunosfiler<span class="o">]</span> Creating shared folders metadata...
<span class="o">[</span>sunosfiler<span class="o">]</span> Clearing any previously <span class="nb">set </span>network interfaces...
<span class="o">[</span>sunosfiler<span class="o">]</span> Preparing network interfaces based on configuration...
<span class="o">[</span>sunosfiler<span class="o">]</span> Forwarding ports...
<span class="o">[</span>sunosfiler<span class="o">]</span> -- <span class="nv">22</span> <span class="o">=</span>&gt; <span class="m">2222</span> <span class="o">(</span>adapter 1<span class="o">)</span>
<span class="o">[</span>sunosfiler<span class="o">]</span> Running any VM customizations...
<span class="o">[</span>sunosfiler<span class="o">]</span> Booting VM...
<span class="o">[</span>sunosfiler<span class="o">]</span> Waiting <span class="k">for</span> VM to boot. This can take a few minutes.
<span class="o">[</span>sunosfiler<span class="o">]</span> VM booted and ready <span class="k">for</span> use!
<span class="o">[</span>sunosfiler<span class="o">]</span> Setting hostname...
</pre></div>


<p>Now we login and become the root user.</p>
<div class="highlight"><pre>vagrant ssh
sudo -i
</pre></div>


<p>Next let's take a look at the disks that we attached. You can use the format command to list the availible disks.</p>
<div class="highlight"><pre>format
Searching <span class="k">for</span> disks...done


AVAILABLE DISK SELECTIONS:
       0. c7d0 &lt;VBOX HAR-bafb5063-0735aa9-0001-8.00GB&gt;
          /pci@0,0/pci-ide@1,1/ide@0/cmdk@0,0
       1. c8d0 &lt;VBOX HAR-196ca772-16ab95f-0001 cyl <span class="m">4093</span> alt <span class="m">2</span> hd <span class="m">128</span> sec 32&gt;
          /pci@0,0/pci-ide@1,1/ide@1/cmdk@0,0
       2. c9t1d0 &lt;ATA-VBOX HARDDISK-1.0 cyl <span class="m">1022</span> alt <span class="m">2</span> hd <span class="m">64</span> sec 32&gt;
          /pci@0,0/pci8086,2829@d/disk@1,0
       3. c9t2d0 &lt;ATA-VBOX HARDDISK-1.0 cyl <span class="m">1022</span> alt <span class="m">2</span> hd <span class="m">64</span> sec 32&gt;
          /pci@0,0/pci8086,2829@d/disk@2,0
       4. c9t3d0 &lt;ATA-VBOX HARDDISK-1.0 cyl <span class="m">1022</span> alt <span class="m">2</span> hd <span class="m">64</span> sec 32&gt;
          /pci@0,0/pci8086,2829@d/disk@3,0
       5. c9t4d0 &lt;ATA-VBOX HARDDISK-1.0 cyl <span class="m">1022</span> alt <span class="m">2</span> hd <span class="m">64</span> sec 32&gt;
          /pci@0,0/pci8086,2829@d/disk@4,0
       6. c9t5d0 &lt;ATA-VBOX HARDDISK-1.0 cyl <span class="m">1022</span> alt <span class="m">2</span> hd <span class="m">64</span> sec 32&gt;
          /pci@0,0/pci8086,2829@d/disk@5,0
       7. c9t6d0 &lt;ATA-VBOX HARDDISK-1.0 cyl <span class="m">1022</span> alt <span class="m">2</span> hd <span class="m">64</span> sec 32&gt;
          /pci@0,0/pci8086,2829@d/disk@6,0
Specify disk <span class="o">(</span>enter its number<span class="o">)</span>:
</pre></div>


<p>You can see that c7d0 and c8d0 are our 8G system disks attached to the IDE controller. Let's attach c8d0 to the rpool and make a mirror.</p>
<div class="highlight"><pre>zpool attach rpool c7d0 c8d0
Make sure to <span class="nb">wait </span><span class="k">until</span> resilver is <span class="k">done</span> before rebooting.
</pre></div>


<p>If we examine the pool now, we can see it resilvering.</p>
<div class="highlight"><pre><span class="nx">zpool</span> <span class="nx">status</span> <span class="nx">rpool</span>
  <span class="nx">pool</span><span class="o">:</span> <span class="nx">rpool</span>
 <span class="nx">state</span><span class="o">:</span> <span class="nx">DEGRADED</span>
<span class="nx">status</span><span class="o">:</span> <span class="nx">One</span> <span class="nx">or</span> <span class="nx">more</span> <span class="nx">devices</span> <span class="nx">is</span> <span class="nx">currently</span> <span class="nx">being</span> <span class="nx">resilvered</span><span class="p">.</span>  <span class="nx">The</span> <span class="nx">pool</span> <span class="nx">will</span>
        <span class="k">continue</span> <span class="nx">to</span> <span class="kd">function</span> <span class="k">in</span> <span class="nx">a</span> <span class="nx">degraded</span> <span class="nx">state</span><span class="p">.</span>
<span class="nx">action</span><span class="o">:</span> <span class="nx">Wait</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">resilver</span> <span class="nx">to</span> <span class="nx">complete</span><span class="p">.</span>
        <span class="nx">Run</span> <span class="s1">&#39;zpool status -v&#39;</span> <span class="nx">to</span> <span class="nx">see</span> <span class="nx">device</span> <span class="nx">specific</span> <span class="nx">details</span><span class="p">.</span>
  <span class="nx">scan</span><span class="o">:</span> <span class="nx">resilver</span> <span class="k">in</span> <span class="nx">progress</span> <span class="nx">since</span> <span class="nx">Thu</span> <span class="nx">Feb</span> <span class="mi">20</span> <span class="mi">19</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mi">00</span> <span class="mi">2014</span>
    <span class="mi">809</span><span class="nx">M</span> <span class="nx">scanned</span> <span class="nx">out</span> <span class="nx">of</span> <span class="mf">3.69</span><span class="nx">G</span> <span class="nx">at</span> <span class="mf">38.5</span><span class="nx">M</span><span class="o">/</span><span class="nx">s</span><span class="p">,</span> <span class="mi">0</span><span class="nx">h1m</span> <span class="nx">to</span> <span class="nx">go</span>
    <span class="mi">777</span><span class="nx">M</span> <span class="nx">resilvered</span><span class="p">,</span> <span class="mf">21.40</span><span class="o">%</span> <span class="nx">done</span>
<span class="nx">config</span><span class="o">:</span>

        <span class="nx">NAME</span>        <span class="nx">STATE</span>     <span class="nx">READ</span> <span class="nx">WRITE</span> <span class="nx">CKSUM</span>
        <span class="nx">rpool</span>       <span class="nx">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
          <span class="nx">mirror</span><span class="o">-</span><span class="mi">0</span>  <span class="nx">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="nx">c7d0</span>    <span class="nx">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="nx">c8d0</span>    <span class="nx">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>  <span class="p">(</span><span class="nx">resilvering</span><span class="p">)</span>

<span class="nx">errors</span><span class="o">:</span> <span class="nx">No</span> <span class="nx">known</span> <span class="nx">data</span> <span class="nx">errors</span>
</pre></div>


<p>After a few minutes it should be fully online. Then we need to install grub on the new disk</p>
<div class="highlight"><pre>bootadm install-bootloader -P rpool
</pre></div>


<p>Now that our root pool is setup we can move on to our storage pool. I choose to mirror every disk but you can choose whatever raid configuration you prefer.</p>
<div class="highlight"><pre>zpool create stark mirror c9t1d0 c9t2d0 mirror c9t3d0 c9t4d0 mirror c9t5d0 c9t6d0
zpool status stark
  pool: stark
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        stark       ONLINE       <span class="m">0</span>     <span class="m">0</span>     0
          mirror-0  ONLINE       <span class="m">0</span>     <span class="m">0</span>     0
            c9t1d0  ONLINE       <span class="m">0</span>     <span class="m">0</span>     0
            c9t2d0  ONLINE       <span class="m">0</span>     <span class="m">0</span>     0
          mirror-1  ONLINE       <span class="m">0</span>     <span class="m">0</span>     0
            c9t3d0  ONLINE       <span class="m">0</span>     <span class="m">0</span>     0
            c9t4d0  ONLINE       <span class="m">0</span>     <span class="m">0</span>     0
          mirror-2  ONLINE       <span class="m">0</span>     <span class="m">0</span>     0
            c9t5d0  ONLINE       <span class="m">0</span>     <span class="m">0</span>     0
            c9t6d0  ONLINE       <span class="m">0</span>     <span class="m">0</span>     0

errors: No known data errors
</pre></div>


<p>At this point our storage is configured and we can move on to creating filesystems, setting up services, or running tests.</p>
<p>Happy Hacking!</p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="http://blkperl.github.com/remove_solaris_patch.html" rel="bookmark"
                           title="Permalink to Removing a patch from Solaris 10">Removing a patch from Solaris 10</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-03-27T12:00:00-07:00">
                Published: Wed 27 March 2013
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://blkperl.github.com/author/william-van-hevelingen.html">William Van Hevelingen</a>
        </address>
<p>In <a href="http://blkperl.github.com/category/solaris.html">solaris</a>. </p>
<p>tags: <a href="http://blkperl.github.com/tag/solaris.html">solaris</a> </p>
</footer><!-- /.post-info -->                <p>How to remove a patch on Solaris 10</p>
                <a class="readmore" href="http://blkperl.github.com/remove_solaris_patch.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
<p class="paginator">
    Page 1 / 1
</p>
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://blkperl.github.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/pdx_blkperl">twitter</a></li>
                            <li><a href="https://github.com/blkperl">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>