<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>puppet resource blog author=blkperl - drbd</title>
        <link rel="stylesheet" href="http://blkperl.github.com/theme/css/main.css" />
        <link href="http://blkperl.github.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="puppet resource blog author=blkperl Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://blkperl.github.com/">puppet resource blog author=blkperl </a></h1>
                <nav><ul>
                    <li><a href="http://blkperl.github.com/category/centos.html">centos</a></li>
                    <li><a href="http://blkperl.github.com/category/ganeti.html">ganeti</a></li>
                    <li><a href="http://blkperl.github.com/category/lxc.html">lxc</a></li>
                    <li><a href="http://blkperl.github.com/category/puppet.html">puppet</a></li>
                    <li><a href="http://blkperl.github.com/category/solaris.html">solaris</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://blkperl.github.com/split-brain-ganeti.html">Fixing a split brain Ganeti instance</a></h1>
<footer class="post-info">
        <abbr class="published" title="2013-05-24T23:08:00-07:00">
                Published: Fri 24 May 2013
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://blkperl.github.com/author/william-van-hevelingen.html">William Van Hevelingen</a>
        </address>
<p>In <a href="http://blkperl.github.com/category/ganeti.html">ganeti</a>. </p>
<p>tags: <a href="http://blkperl.github.com/tag/ganeti.html">ganeti</a> <a href="http://blkperl.github.com/tag/kvm.html">kvm</a> <a href="http://blkperl.github.com/tag/drbd.html">drbd</a> </p>
</footer><!-- /.post-info --><h2>Recovering from split brain</h2>
<p>We run a 4 node Ganeti cluster and during a failover of a node some instances got degraded disks. We're not sure how it happened but some quick googling told us it was a split brain and is recoverable. The following is how we confirmed it was split brain and how we repaired the affected instances.</p>
<h2>You can identify a split brain by the following.</h2>
<p>Degraded disks in gnt-instance info</p>
<div class="highlight"><pre>on primary:   /dev/drbd1 <span class="o">(</span>147:1<span class="o">)</span> in sync, status *DEGRADED*
on secondary: /dev/drbd9 <span class="o">(</span>147:9<span class="o">)</span> in sync, status *DEGRADED*
</pre></div>


<p>StandAlone state on the primary (/proc/drbd)</p>
<div class="highlight"><pre> 1: cs:StandAlone ro:Primary/Unknown ds:UpToDate/DUnknown   r-----
    ns:969536 nr:0 dw:22564060 dr:43036016 al:242 bm:2652 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:254024
</pre></div>


<p>StandAlone state on the secondary (/proc/drbd)</p>
<div class="highlight"><pre>9: cs:StandAlone ro:Primary/Unknown ds:UpToDate/DUnknown   r-----
    ns:0 nr:969536 dw:24185104 dr:996 al:0 bm:1293 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
</pre></div>


<h1>Steps to repair</h1>
<h2>Recreate the secondary</h2>
<p>(assuming you think the primary is healthy)</p>
<div class="highlight"><pre><span class="c"># replace $another_node with any node that is not the primary or secondary</span>
gnt-instance replace-disks -n <span class="nv">$another_node</span> <span class="nv">$instance</span>
</pre></div>


<h2>Wait for disks to re-sync</h2>
<p>You can watch the progress by looking at /proc/drbd</p>
<div class="highlight"><pre>1: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----
    ns:16437312 nr:0 dw:22602340 dr:59475304 al:256 bm:3653 lo:1 pe:123 ua:64 ap:0 ep:1 wo:f oos:4555336
        <span class="o">[==============</span>&gt;.....<span class="o">]</span> synced: 78.3% <span class="o">(</span>4448/20480<span class="o">)</span>Mfinish: 0:01:14 speed: 61,144 <span class="o">(</span>58,212<span class="o">)</span> K/sec
</pre></div>


<h2>Verify the disks now</h2>
<div class="highlight"><pre>gnt-instance info <span class="nv">$instance</span> <span class="p">|</span> grep drbd
  Disk template: drbd
    - disk/0: drbd8, size 20.0G
      on primary:   /dev/drbd1 <span class="o">(</span>147:1<span class="o">)</span> in sync, status ok
      on secondary: /dev/drbd1 <span class="o">(</span>147:1<span class="o">)</span> in sync, status ok
</pre></div>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://blkperl.github.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/pdx_blkperl">twitter</a></li>
                            <li><a href="https://github.com/blkperl">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>