<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>puppet resource blog author=blkperl - leonardo</title>
        <link rel="stylesheet" href="http://blkperl.github.com/theme/css/main.css" />
        <link href="http://blkperl.github.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="puppet resource blog author=blkperl Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://blkperl.github.com/">puppet resource blog author=blkperl </a></h1>
                <nav><ul>
                    <li><a href="http://blkperl.github.com/category/centos.html">centos</a></li>
                    <li><a href="http://blkperl.github.com/category/ganeti.html">ganeti</a></li>
                    <li><a href="http://blkperl.github.com/category/lxc.html">lxc</a></li>
                    <li><a href="http://blkperl.github.com/category/puppet.html">puppet</a></li>
                    <li><a href="http://blkperl.github.com/category/solaris.html">solaris</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://blkperl.github.com/building_devops_dashboards_with_puppet.html">Building DevOps Dashboards with Puppet</a></h1>
<footer class="post-info">
        <abbr class="published" title="2014-04-17T00:13:00-07:00">
                Published: Thu 17 April 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://blkperl.github.com/author/william-van-hevelingen.html">William Van Hevelingen</a>
        </address>
<p>In <a href="http://blkperl.github.com/category/puppet.html">puppet</a>. </p>
<p>tags: <a href="http://blkperl.github.com/tag/puppet.html">puppet</a> <a href="http://blkperl.github.com/tag/graphite.html">graphite</a> <a href="http://blkperl.github.com/tag/leonardo.html">leonardo</a> <a href="http://blkperl.github.com/tag/metrics.html">metrics</a> </p>
</footer><!-- /.post-info --><p>Graphite is awesome. The variety of metrics that you can put in it and the ability to build graphs to visualize specific things is an invaluable tool. However, most of the time, I just want to be able to do a quick glance at a few key things on a server like CPU usage, memory usage, disk I/O, and network traffic. While it's easy to bring these graphs up individually, in the default Graphite web UI, it's a bit harder to flip through several different server metrics quickly. Not to mention getting them in the particular way you want to view them.</p>
<p>At this point, you want to build a DevOps dashboard and there's a ton of choices to choose from that goes way beyond the capabilities of the default Graphite web UI. Although, you still end up with the problem of building a dashboard for each host and I have 200+ nodes. Sure, I could write a script to do it but why repeat myself when Puppet could do this for me.</p>
<p>I just needed to find a Graphite dashboard that I could easily model in Puppet via config files. Originally, I looked at Gdash by @ripienaar. It implements a simple DSL for Graphite that I could have easily modeled in Puppet templates but I just so happened upon the following tweet.</p>
<blockquote class="twitter-tweet" lang="en"><p>New GDash inspired dashboard for Graphite <a href="http://t.co/8AJEZX1Jvl">http://t.co/8AJEZX1Jvl</a> from <a href="https://twitter.com/juliendehee">@juliendehee</a></p>&mdash; R.I.Pienaar (@ripienaar) <a href="https://twitter.com/ripienaar/statuses/423934247750365184">January 16, 2014</a></blockquote>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>@juliendehee's Leonardo dashboard for Graphite is a simple Python Flask app that hits the Graphite render API to generate graphs. Instead of a DSL language like GDash it uses YAML files. At this point, I was positive someone had already written a Puppet type for YAML. So, I went looking on the Puppet Forge and sure enough Reid had already done the work for me.</p>
<p><a href="https://forge.puppetlabs.com/reidmv/yamlfile">https://forge.puppetlabs.com/reidmv/yamlfile</a></p>
<p>A few hours of hacking later and I had a Puppet module for Leonardo. It works exactly like the Nagios host/service pattern using exported resources.</p>
<h2>Prerequisites</h2>
<ul>
<li>Your Puppet Masters need to be using PuppetDB.</li>
<li>You need to install a recent version of Puppet (&gt;= 3.4.x) with Future parser enabled</li>
</ul>
<h2>Installation</h2>
<p>To get started you need to add the leonardo module to your Puppet masters.</p>
<div class="highlight"><pre>puppet module install pdxcat-leonardo
</pre></div>


<p>Or you can download it directly from <a href="https://github.com/pdxcat/puppet-module-leonardo">GitHub</a>.</p>
<h2>Leonardo server configuration</h2>
<p>Next, you will want to install Leonardo on a webserver. Below, you can see my <code>role::leonardo</code> puppet class. Include this class in your leonardo servers node definition. The leonardo class installs the packages needed for Leonardo, does some basic configuration and does a git clone of the source code from GitHub [1]. You can choose to omit the Leonardo class if you want to do it differently. Also since web server configuration is usually environment specific, I'm going to omit it from this blog post but here is an example for setting it up with Apache in the <code>test/init.pp</code> file using the puppetlabs/apache module [2].</p>
<p>The key lines to understand in this code snippet is the "mothership" operators also called exported resource collectors [3]. Lines 15-17 will collect all the leonardo resources that we are going to export on our target nodes. Then whenever the leonardo server checks in with Puppet it will ensure that all leonardo resources are created.</p>
<div class="gist">
    <script src='https://gist.github.com/10956900.js'></script>
    <noscript>
        <pre><code>class role::leonardo {

  $template_dir = '/opt/leonardo/leonardo/graphs'

  class { '::leonardo':
    graphite_url => 'https://graphite.example.org',
    template_dir => $template_dir,
    install_dir  => '/opt/leonardo/leonardo',
  }->
  file { [$template_dir, "${template_dir}/servers"]:
    ensure => directory,
  }

  # Environment tag can be removed when environment support is added to PuppetDB
  File                <<| tag == "env_leonardo_${::environment}" |>> {}
  Leonardo::Dashboard <<| tag == "env_leonardo_${::environment}" |>> {}
  Leonardo::Graph     <<| tag == "env_leonardo_${::environment}" |>> {}
}
</code></pre>
    </noscript>
</div>
<h2>Leonardo client configuration</h2>
<p>For the target node configuration we need to export resources. The following code snippet contains an example of <code>role::leonardo::client</code>. Include the <code>role::leonardo::client</code> class on every node that you want a dashboard for.</p>
<div class="gist">
    <script src='https://gist.github.com/9826382.js'></script>
    <noscript>
        <pre><code>class role::leonardo::client {

  $dashboard_root = '/opt/leonardo/graphs/servers',
  $collectd_name  = regsubst($::fqdn, '\.', '_', 'G'),
  $dashboard_dir  = "${dashboard_root}/${::hostname}",

  # Each dashboard needs a directory to hold the graph files
  @@file { $dashboard_dir:
    ensure => directory,
    mode   => '0755',
    tag    => "env_leonardo_${environment}",
  }

  # Each dashboard needs a a dash.yaml file
  @@leonardo::dashboard { $::hostname:
    target             => "${dashboard_dir}/dash.yaml",
    name               => $::hostname,
    description        => 'System Metrics',
    include_properties => ['common.yaml'],
    tag                => "env_leonardo_${environment}",
    require            => File[$dashboard_dir],
  }
  
  # Export a cpu graph
  @@leonardo::graph { "${::hostname}-cpu":
    target     => "${dashboard_dir}/10-cpu.graph",
    parameters => { 'title'  => 'Combined CPU Usage',
                    'vtitle' => 'percent',
                    'area'   => 'stacked' },
    fields     => {
                    'iowait' => { 'data' => "sumSeries(collectd.${collectd_name}.cpu*.cpu-wait)",},
                    'system' => { 'data' => "sumSeries(collectd.${collectd_name}.cpu*.cpu-system)",},
                    'user'   => { 'data' => "sumSeries(collectd.${collectd_name}.cpu*.cpu-user)",},
                  },
    tag       => "env_leonardo_${environment}",
    require   => File[$dashboard_dir],
  }

}</code></pre>
    </noscript>
</div>
<p>In this particular example, we are exporting a leonardo dashboard file, a directory for each server to hold the graphs, and a CPU graph. Check out the link at the bottom for our current list of graphs that we export on all nodes [4]. It should be a good starting point for getting the more common graphs up and running.</p>
<h2>Graphs and Profit!</h2>
<p>After running Puppet on both the target node and the Leonardo server, you should see a servers dropdown menu. Upon selecting a server from the list you should see something similar to the dashboard below.</p>
<p><img alt="Leonardo Dashboard" src="http://blkperl.github.com/images/leonardo_dashboard.png" /></p>
<p>Once you're confident that you have the graphs you want defined in Puppet and have tested on one node. Include the leonardo client class on all your nodes and watch as it creates a dashboard for each server as Puppet nodes start to check in and Puppet runs on your Leonardo server.</p>
<h2>Role Based Graphs</h2>
<p>Now that we have a bunch of graphs that should be displayed for each node we can start adding ones for specific roles. Similar to the way you might export Nagios service checks depending on a Puppet class we can do the same with exporting leonardo dashboard resources.</p>
<p>Let's say we have an OpenVPN role. Normally, we would have have our server configuration, monitoring, and environment specific code defined in this file so adding leonardo resources is a natural extension.</p>
<div class="gist">
    <script src='https://gist.github.com/10961436.js'></script>
    <noscript>
        <pre><code>class role::vpnserver {

  class { 'openvpn::server':
     # environment specific parameters
  }

  class { 'collectd::plugin::openvpn':
    # environment specific parameters
  }

  @@leonardo::graph { "${::hostname}-openvpn":
    target     => "${dashboard_dir}/90-openvpn.graph",
    parameters => { 'title'    => 'OpenVPN connected users',
                    'vtitle'   => 'Users',
                    'linemode' => 'connected' },
    fields     => {
                    'users'   => { 'data' => "sumSeries(collectd.${collectd_name}.openvpn*.*)",},
                  },
    tag       => "env_leonardo_${environment}",
  }

}
</code></pre>
    </noscript>
</div>
<p>This ability is incredibly powerful because all that metadata that Puppet knows about your infrastructure via puppet classes is now available to help you build automated dashboards. You can take it a step further by exporting Graphs to role-based Dashboards. For example, a custom dashboard for an applications with graphs from the webservers, load balancers, and database servers.</p>
<h2>Caveats</h2>
<p>The current implement has a few issues that I'm going to gloss over in this post. Pull requests are welcome to help fix these problems.</p>
<ul>
<li>Removing exported resources from PuppetDB is still a bit of a challenge</li>
<li>Currently, old dashboards need to be manually removed as a purge parameter has not yet been implemented</li>
<li>Yamlfile can be really slow on initial runs with a large number of hosts</li>
</ul>
<h2>Summary</h2>
<p>TL;DR I used unreleased Puppet features to make shiny dashboards with very little effort thanks to Graphite, Collectd and Puppet.</p>
<h2>Resources</h2>
<ul>
<li><a href="http://docs.puppetlabs.com/puppet/latest/reference/experiments_future.html">Puppet Future Parser</a></li>
<li><a href="https://docs.puppetlabs.com/puppetdb/latest/">PuppetDB</a></li>
</ul>
<h2>References</h2>
<ul>
<li>[1] At the time of writing there are no packages for Leonardo available</li>
<li>[2] <a href="https://github.com/pdxcat/puppet-module-leonardo/blob/master/tests/init.pp">Installing Leonardo with Apache example puppet manifest</a></li>
<li>[3] <a href="http://docs.puppetlabs.com/puppet/latest/reference/lang_exported.html#collecting-exported-resources">Docs on Exported resource collectors</a></li>
<li>[4] <a href="https://gist.github.com/blkperl/10958057">Full Leonardo client example</a> (Note: this very much a work in progress)</li>
</ul>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://blkperl.github.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/pdx_blkperl">twitter</a></li>
                            <li><a href="https://github.com/blkperl">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>